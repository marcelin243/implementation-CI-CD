name: Django CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12.2'  # Remplacez par votre version Python souhaitée

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest


      - name: Publish
        run: |
             echo -e "${{ secrets.SSH_KEY }}" > __TEMP_INPUT_KEY_FILE
             chmod 600 __TEMP_INPUT_KEY_FILE   

             # Ajouter la clé SSH à l'agent
             eval "$(ssh-agent -s)"  # Démarre l'agent SSH
             ssh-add __TEMP_INPUT_KEY_FILE  # Ajoute la clé   
             
             ssh -o StrictHostKeyChecking=no -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}"@"${{ secrets.SSH_HOST }}" "sudo rm -rf /home/pftckq/public_html/*"
             scp -o StrictHostKeyChecking=no -P "${{ secrets.SSH_PORT }}" -r . "${{ secrets.SSH_USER }}"@"${{ secrets.SSH_HOST }}":"/home/pftckq/public_html/"
             ssh -o StrictHostKeyChecking=no -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}"@"${{ secrets.SSH_HOST }}" "cd /home/pftckq/public_html/ && python -m pip install -r requirements.txt"
             ssh -o StrictHostKeyChecking=no -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}"@"${{ secrets.SSH_HOST }}" "sudo systemctl restart your_gunicorn_service"

             rm __TEMP_INPUT_KEY_FILE